name: CD for Microservices

on:
  workflow_run:
    workflows: ["CI for Microservices"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # √âtape 1 : R√©cup√©rer le code source
      - name: Checkout code
        uses: actions/checkout@v3

      # √âtape 2 : Installer DVC et r√©cup√©rer les donn√©es depuis DagsHub
      - name: Install DVC & Pull Data
        run: |
          pip install dvc
          dvc remote add origin https://dagshub.com/bmle-aug24/Meteo_group.dvc
          dvc remote modify origin auth basic
          dvc remote modify origin user bmle-aug24
          dvc remote modify origin password 80f0fd7d1ab6a2b1e95664936d78045d71c78e17
          dvc pull

      # √âtape 3 : D√©ployer les services avec Docker Compose
      - name: Deploy with Docker Compose
        run: |
          docker-compose down # Arr√™ter les services existants
          docker-compose up -d # Lancer les services d√©finis dans docker-compose.yml

      # √âtape 4 : Pousser les donn√©es versionn√©es vers DagsHub
      - name: Version RAW Data and Push to DagsHub
        run: |
          dvc add data/raw # Ajouter les donn√©es RAW g√©n√©r√©es par ingestion
          git add data/raw.dvc .gitignore
          git commit -m "Versionnement des donn√©es RAW (ingestion)"
          dvc push

      # √âtape 5 : Versionner les donn√©es trait√©es et le mod√®le
      - name: Push Processed Data and Model to DagsHub
        run: |
          # Ajouter les donn√©es pr√©trait√©es
          dvc add data/processed/X_train.csv
          dvc add data/processed/X_test.csv
          dvc add data/processed/y_train.csv
          dvc add data/processed/y_test.csv

          dvc add mlflow/latest_model.pkl  

          git add data/processed/*.dvc mlflow/latest_model.pkl.dvc .gitignore
          git commit -m "Mise √† jour des donn√©es trait√©es et du mod√®le entra√Æn√©"
          git push origin main  # üìå Pousser les m√©tadonn√©es DVC vers GitHub

          dvc push