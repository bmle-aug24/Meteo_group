# name: CD for Microservices

# on:
#   workflow_run:
#     workflows: ["CI for Microservices"]
#     types:
#       - completed

# jobs:
#   deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # Étape 1 : Récupérer le code source
#       - name: Checkout code
#         uses: actions/checkout@v3

#       # Étape 2 : Installer DVC et récupérer les données depuis DagsHub
#       - name: Install DVC & Pull Data
#         run: |
#           pip install dvc
#           dvc remote add origin https://dagshub.com/bmle-aug24/Meteo_group.dvc
#           dvc remote modify origin auth basic
#           dvc remote modify origin user bmle-aug24
#           dvc remote modify origin password 80f0fd7d1ab6a2b1e95664936d78045d71c78e17
#           dvc pull

#       # Étape 3 : Déployer les services avec Docker Compose
#       - name: Deploy with Docker Compose
#         run: |
#           docker-compose down # Arrêter les services existants
#           docker-compose up -d # Lancer les services définis dans docker-compose.yml

#       # Étape 4 : Pousser les données versionnées vers DagsHub
#       - name: Version RAW Data and Push to DagsHub
#         run: |
#           dvc add data/raw # Ajouter les données RAW générées par ingestion
#           git add data/raw.dvc .gitignore
#           git commit -m "Versionnement des données RAW (ingestion)"
#           dvc push

#       # Étape 5 : Versionner les données traitées et le modèle
#       - name: Push Processed Data and Model to DagsHub
#         run: |
#           dvc add data/processed/X_train.csv
#           dvc add data/processed/X_test.csv
#           dvc add data/processed/y_train.csv
#           dvc add data/processed/y_test.csv
#           dvc add mlflow/*
#           git add data/processed/*.dvc mlflow/*.dvc .gitignore
#           git commit -m "Mise à jour des données traitées et du modèle entraîné"
#           dvc push

name: CD for Microservices

on:
  workflow_run:
    workflows: ["CI for Microservices"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Étape 1 : Récupérer le code source
      - name: Checkout code
        uses: actions/checkout@v3

      # Étape 2 : Installer DVC et récupérer les données depuis DagsHub de manière sécurisée
      - name: Install DVC & Pull Data
        env:
          DVC_PASSWORD: ${{ secrets.DVC_PASSWORD }}
        run: |
          apt update 
           apt install -y git 
          pip install dvc
          pip install dvc 
          git init 
          git config --global user.email 'you@example.com' 
          git config --global user.name 'Your Name' 
          dvc init -f 
          git add .dvc 
          git commit -m 'Initialize DVC' 
          dvc remote add origin https://dagshub.com/bmle-aug24/Meteo_group.dvc
          dvc remote modify origin auth basic
          dvc remote modify origin user bmle-aug24

          dvc pull

      # Étape 3 : Déployer les services avec Docker Compose
      - name: Deploy with Docker Compose
        run: |
          docker-compose down --remove-orphans # Arrêter proprement les services
          docker-compose up -d --build # Lancer les services en reconstruisant les images

      # Étape 5 : Versionner et pousser les données RAW vers DagsHub
      - name: Version RAW Data and Push to DagsHub
        run: |
          dvc add data/raw || true
          git add data/raw.dvc .gitignore
          git commit -m "Versionnement des données RAW (ingestion)" || true
          dvc push

      # Étape 6 : Versionner et pousser les données traitées et le modèle
      - name: Push Processed Data and Model to DagsHub
        run: |
          dvc add data/processed/X_train.csv
          dvc add data/processed/X_test.csv
          dvc add data/processed/y_train.csv
          dvc add data/processed/y_test.csv
          dvc add config/model/xgboost_model.json
          dvc add mlflow/
          git add data/processed/*.dvc config/model/xgboost_model.json.dvc mlflow/*.dvc .gitignore
          git commit -m "Mise à jour des données traitées et du modèle entraîné" || true
          dvc push
